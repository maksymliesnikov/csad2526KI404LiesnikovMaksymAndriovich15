name: CI Cross Build

on:
  push:
    branches:
      - '*develop*'
      - '*master*'
  pull_request:
    branches:
      - '*develop*'
      - '*master*'

jobs:
  cross_build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python (needed for some tooling)
        if: runner.os != 'Windows'
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # Install CMake if not already present
      - name: Install CMake on Linux
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential ninja-build || true

      - name: Install CMake on macOS
        if: runner.os == 'macOS'
        run: |
          brew update || true
          brew install cmake ninja || true

      - name: Install CMake on Windows
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          choco install -y cmake --installargs 'ADD_CMAKE_TO_PATH=System' || true

      # Make CI scripts executable on Unix-like systems
      - name: Ensure Unix CI script is executable
        if: runner.os != 'Windows'
        run: |
          if [ -f ./ci.sh ]; then chmod +x ./ci.sh; fi

      # Run configure & build using repository scripts (ci.sh / ci.cmd)
      - name: Configure and build (Unix)
        if: runner.os != 'Windows'
        run: |
          if [ -f ./ci.sh ]; then 
            ./ci.sh
          else 
            # Set number of cores for parallel build
            if [[ "$RUNNER_OS" == "Linux" ]]; then
              CORES=$(nproc)
            elif [[ "$RUNNER_OS" == "macOS" ]]; then
              CORES=$(sysctl -n hw.ncpu)
            else
              CORES=2 # Default fallback
            fi
            
            echo "Using $CORES cores for build..."
            cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
            cmake --build build -- -j$CORES
          fi

      - name: Configure and build (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          if (Test-Path -Path .\ci.cmd) { .\ci.cmd } else { cmake -S . -B build -A x64 -DCMAKE_BUILD_TYPE=Release; cmake --build build --config Release -- /m }

      # Run tests with CTest if build produced tests
      - name: Run CTest
        if: runner.os != 'Windows'
        run: |
          if [ -d build ]; then 
            cd build
            # Build will fail if tests fail
            ctest --output-on-failure
          fi

      - name: Run CTest (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          if (Test-Path -Path .\build) { 
            Push-Location build
            # Build will fail if tests fail
            ctest -C Release --output-on-failure
            Pop-Location 
          }

      # Deploy / Upload build artifacts
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}
          path: build/  # Більш стандартний шлях, або залиште 'build/**'